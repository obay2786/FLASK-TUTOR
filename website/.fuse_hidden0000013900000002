from PIL import Image, ImageOps
import base64
from io import BytesIO
import os 
import secrets
import requests
import json
import sqlalchemy as db

def saveImages(photo):
    randomHex = secrets.token_hex(8)
    _, file_ex = os.path.splitext(photo.filename)
    pictureFn = randomHex + file_ex
    picturePath = os.path.join(os.getcwd(),'upload/staff',pictureFn)
    img = Image.open(photo)
    img = ImageOps.exif_transpose(img)
    output_size = (700, 700)
    img.thumbnail(output_size)
    img.save(picturePath)
    return pictureFn



# testpermit()
'''
nikCovid = [{"nama":"johan","nik":"123"},{"nama":"budi","nik":"890"}] #databasecovid
nikVisitor = [{"nama":"johan","nik":"123"},{"nama":"budi","nik":"456"}] #databaseVisitor
nikPermit = [{"nama":"johan","nik":"123", "register" : "belum","covid" : "belum"},{"nama":"budi","nik":"456","register":"belum","covid":"belum"},{"nama":"tino","nik":"789","register" : "belum","covid" : "belum"}] #jotform


for num,i in enumerate(nikPermit):
    if num < len(nikCovid):
        if i['nik'] == nikCovid[num]['nik']:
            nikPermit[num]['register'] = "terdaftar"
            # print(j)
    if num < len(nikVisitor):
        if i['nik'] == nikVisitor[num]['nik']:
            nikPermit[num]['covid'] = "terdaftar"


print(nikPermit)
'''
jfToken = '1c003a23731a647ba58829de69911ea8'
dbpana = "mssql+pymssql://sa:Batam2021@103.142.240.134:1433/VMS"
def getJFpermit2():
    r = requests.get(f'https://api.jotform.com/form/213014916686458/submissions?apiKey={jfToken}')
    hasil = json.loads(r.text)
    dictJF = {}
    listJF =[]

    for data in hasil["content"]:
        if data['status'] == 'ACTIVE':
            dictJF['id'] = data['id']

            dictJF['subDate'] = data['created_at']
            
            if data['answers']['59']['answer'] == 'WORKING' or data['answers']['59']['answer'] == 'OVERTIME':
                dictJF['permitNo'] = data['answers']['15']['answer'] 
                dictJF['desk'] = data['answers']['16']['answer'] 
            else:
                dictJF['permitNo'] = ""
                dictJF['desk'] = ""

            dictJF['email'] = data['answers']['28']['answer'] 

            dictJF['startDate'] = data['answers']['46']['prettyFormat'] 

            dictJF['sign'] = data['answers']['47']['answer'] 

            #bikin func anggota mulai disini
            anggota = json.loads(data['answers']['51']['answer'])
            
            # print(anggota)
            
            engine = db.create_engine(dbpana)
            connection = engine.connect()
            metadata = db.MetaData()
            permitDb = db.Table('covid', metadata, autoload=True, autoload_with=engine)
            query = db.select([permitDb])

            ResultProxy = connection.execute(query)

            ResultSet = ResultProxy.fetchall()

            for i in ResultSet:
                print(i)

            # listAnggota = []
            # for a in range(10):
            #     if a >= len(anggota):
            #         listAnggota.append({"Nama":"","NIK":"","Jabatan":""})
            #     else:
            #         listAnggota.append(anggota[a])

            # dictJF['anggota'] = json.dumps(listAnggota)

            # dictJF['bawaBarang'] = data['answers']['54']['answer'] 

           
            # insertPermit(dictJF)
            # print dictJF

        
# getJFpermit2()